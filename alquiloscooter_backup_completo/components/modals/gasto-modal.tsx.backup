
'use client';

import { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Calendar as CalendarIcon, DollarSign, Loader2, FileText, Upload } from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { cn } from '@/lib/utils';
import { InvoiceDocumentManagement, ExtractedInvoiceData } from '@/components/gastos/InvoiceDocumentManagement';

interface GastoModalProps {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
  gastoToEdit?: any;
}

export default function GastoModal({ open, onClose, onSuccess, gastoToEdit }: GastoModalProps) {
  const [loading, setLoading] = useState(false);
  const [vehicles, setVehicles] = useState<any[]>([]);
  const [suppliers, setSuppliers] = useState<any[]>([]);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  
  // Form data
  const [fecha, setFecha] = useState<Date>(new Date());
  const [tipoDocumento, setTipoDocumento] = useState('TICKET');
  const [numeroFactura, setNumeroFactura] = useState('');
  const [proveedor, setProveedor] = useState('');
  const [proveedorCif, setProveedorCif] = useState('');
  const [categoria, setCategoria] = useState('Mantenimiento');
  const [descripcion, setDescripcion] = useState('');
  const [baseImponible, setBaseImponible] = useState('');
  const [ivaPorcentaje, setIvaPorcentaje] = useState('21');
  const [ivaImporte, setIvaImporte] = useState('');
  const [total, setTotal] = useState('');
  const [metodoPago, setMetodoPago] = useState('EFECTIVO');
  const [vehicleId, setVehicleId] = useState<string>('');
  
  // ‚úÖ NUEVO: Manejar datos extra√≠dos del OCR
  const handleExtractedData = (data: ExtractedInvoiceData) => {
    console.log('üìä [GASTO-MODAL] Datos extra√≠dos recibidos:', data);
    
    // Auto-rellenar campos del formulario
    if (data.fecha) {
      try {
        setFecha(new Date(data.fecha));
      } catch (e) {
        console.error('Error parseando fecha:', e);
      }
    }
    
    if (data.tipo_documento) setTipoDocumento(data.tipo_documento);
    if (data.numero_factura) setNumeroFactura(data.numero_factura);
    if (data.proveedor) setProveedor(data.proveedor);
    if (data.proveedor_cif) setProveedorCif(data.proveedor_cif);
    if (data.descripcion) setDescripcion(data.descripcion);
    if (data.categoria) setCategoria(data.categoria);
    if (data.metodo_pago) setMetodoPago(data.metodo_pago);
    
    // Campos num√©ricos
    if (data.base_imponible) setBaseImponible(data.base_imponible.toString());
    if (data.iva_porcentaje) setIvaPorcentaje(data.iva_porcentaje.toString());
    if (data.iva_importe) setIvaImporte(data.iva_importe.toString());
    if (data.total) setTotal(data.total.toString());
    
    console.log('‚úÖ [GASTO-MODAL] Formulario auto-rellenado con OCR');
  };
  
  useEffect(() => {
    if (open) {
      loadVehicles();
      loadSuppliers();
      
      if (gastoToEdit) {
        // Editar gasto existente
        setFecha(new Date(gastoToEdit.fecha));
        setTipoDocumento(gastoToEdit.tipo_documento);
        setNumeroFactura(gastoToEdit.numero_factura || '');
        setProveedor(gastoToEdit.proveedor || '');
        setProveedorCif(gastoToEdit.proveedor_cif || '');
        setCategoria(gastoToEdit.categoria);
        setDescripcion(gastoToEdit.descripcion);
        setBaseImponible(gastoToEdit.base_imponible?.toString() || '');
        setIvaPorcentaje(gastoToEdit.iva_porcentaje?.toString() || '21');
        setIvaImporte(gastoToEdit.iva_importe?.toString() || '');
        setTotal(gastoToEdit.total.toString());
        setMetodoPago(gastoToEdit.metodo_pago);
        setVehicleId(gastoToEdit.vehicle_id?.toString() || '');
      } else {
        // Nuevo gasto - resetear campos
        resetForm();
      }
    }
  }, [open, gastoToEdit]);
  
  const resetForm = () => {
    setFecha(new Date());
    setTipoDocumento('TICKET');
    setNumeroFactura('');
    setProveedor('');
    setProveedorCif('');
    setCategoria('Mantenimiento');
    setDescripcion('');
    setBaseImponible('');
    setIvaPorcentaje('21');
    setIvaImporte('');
    setTotal('');
    setMetodoPago('EFECTIVO');
    setVehicleId('');
    setSelectedFile(null); // Limpiar archivo
  };
  
  const loadVehicles = async () => {
    try {
      const response = await fetch('/api/vehicles');
      if (response?.ok) {
        const data = await response.json();
        // El API devuelve directamente el array de veh√≠culos
        setVehicles(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Error loading vehicles:', error);
    }
  };
  
  const loadSuppliers = async () => {
    try {
      const response = await fetch('/api/suppliers');
      if (response?.ok) {
        const data = await response.json();
        setSuppliers(data.suppliers || []);
      }
    } catch (error) {
      console.error('Error loading suppliers:', error);
    }
  };
  
  // Calcular IVA autom√°ticamente
  useEffect(() => {
    if (tipoDocumento === 'FACTURA' && baseImponible && ivaPorcentaje) {
      const base = parseFloat(baseImponible);
      const iva = parseFloat(ivaPorcentaje);
      if (!isNaN(base) && !isNaN(iva)) {
        const ivaCalc = base * (iva / 100);
        setIvaImporte(ivaCalc.toFixed(2));
        setTotal((base + ivaCalc).toFixed(2));
      }
    }
  }, [tipoDocumento, baseImponible, ivaPorcentaje]);
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!descripcion.trim()) {
      alert('La descripci√≥n es obligatoria');
      return;
    }
    
    if (!total || parseFloat(total) <= 0) {
      alert('El importe total debe ser mayor a 0');
      return;
    }
    
    if (tipoDocumento === 'FACTURA') {
      if (!proveedor.trim()) {
        alert('El proveedor es obligatorio para facturas');
        return;
      }
      if (!numeroFactura.trim()) {
        alert('El n√∫mero de factura es obligatorio');
        return;
      }
      if (!baseImponible || parseFloat(baseImponible) <= 0) {
        alert('La base imponible es obligatoria para facturas');
        return;
      }
    }
    
    setLoading(true);
    
    try {
      // ‚úÖ NUEVO: Usar FormData para subir archivo junto con datos
      const formData = new FormData();
      
      formData.append('fecha', fecha.toISOString());
      formData.append('tipo_documento', tipoDocumento);
      formData.append('categoria', categoria);
      formData.append('descripcion', descripcion);
      formData.append('total', total);
      formData.append('metodo_pago', metodoPago);
      
      if (vehicleId) {
        formData.append('vehicle_id', vehicleId);
      }
      
      // Campos espec√≠ficos de factura
      if (tipoDocumento === 'FACTURA') {
        formData.append('numero_factura', numeroFactura);
        formData.append('proveedor', proveedor);
        formData.append('proveedor_cif', proveedorCif);
        formData.append('base_imponible', baseImponible);
        formData.append('iva_porcentaje', ivaPorcentaje);
      }
      
      // Adjuntar archivo si existe
      if (selectedFile) {
        formData.append('file', selectedFile);
      }
      
      const url = gastoToEdit ? `/api/gastos/${gastoToEdit.id}` : '/api/gastos';
      const method = gastoToEdit ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method,
        body: formData // Ya no enviamos JSON, enviamos FormData
      });
      
      if (!response?.ok) {
        const error = await response?.json();
        throw new Error(error?.error || 'Error al guardar el gasto');
      }
      
      onSuccess();
      onClose();
    } catch (error: any) {
      console.error('Error saving gasto:', error);
      alert(error?.message || 'Error al guardar el gasto');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <DollarSign className="h-5 w-5 text-green-600" />
            {gastoToEdit ? 'Editar Gasto' : 'Nuevo Gasto'}
          </DialogTitle>
        </DialogHeader>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          {/* Fecha */}
          <div className="space-y-2">
            <Label>Fecha del Gasto *</Label>
            <Popover>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    "w-full justify-start text-left font-normal",
                    !fecha && "text-muted-foreground"
                  )}
                >
                  <CalendarIcon className="mr-2 h-4 w-4" />
                  {fecha ? format(fecha, 'PPP', { locale: es }) : 'Selecciona una fecha'}
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-auto p-0" align="start">
                <Calendar
                  mode="single"
                  selected={fecha}
                  onSelect={(date) => date && setFecha(date)}
                  locale={es}
                  initialFocus
                />
              </PopoverContent>
            </Popover>
          </div>
          
          {/* Tipo de Documento */}
          <div className="space-y-2">
            <Label>Tipo de Documento *</Label>
            <Select value={tipoDocumento} onValueChange={setTipoDocumento}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="TICKET">Ticket / Recibo</SelectItem>
                <SelectItem value="FACTURA">Factura</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          {/* Categor√≠a */}
          <div className="space-y-2">
            <Label>Categor√≠a *</Label>
            <Select value={categoria} onValueChange={setCategoria}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="Mantenimiento">Mantenimiento</SelectItem>
                <SelectItem value="Combustible">Combustible</SelectItem>
                <SelectItem value="Seguros">Seguros</SelectItem>
                <SelectItem value="Impuestos">Impuestos</SelectItem>
                <SelectItem value="Limpieza">Limpieza</SelectItem>
                <SelectItem value="Parking">Parking</SelectItem>
                <SelectItem value="Otros">Otros</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          {/* Descripci√≥n */}
          <div className="space-y-2">
            <Label>Descripci√≥n / Concepto *</Label>
            <Textarea
              value={descripcion}
              onChange={(e) => setDescripcion(e.target.value)}
              placeholder="Ej: Cambio de aceite, Combustible, etc."
              rows={2}
            />
          </div>
          
          {/* Veh√≠culo (opcional) */}
          <div className="space-y-2">
            <Label>Veh√≠culo Asociado (opcional)</Label>
            <Select value={vehicleId || "none"} onValueChange={(value) => setVehicleId(value === "none" ? "" : value)}>
              <SelectTrigger>
                <SelectValue placeholder="Ninguno" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="none">Ninguno</SelectItem>
                {vehicles.map((vehicle) => (
                  <SelectItem key={vehicle.id} value={vehicle.id.toString()}>
                    {vehicle.registration_number} - {vehicle.make} {vehicle.model}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          
          {/* Campos espec√≠ficos para FACTURA */}
          {tipoDocumento === 'FACTURA' && (
            <>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>N√∫mero de Factura *</Label>
                  <Input
                    value={numeroFactura}
                    onChange={(e) => setNumeroFactura(e.target.value)}
                    placeholder="Ej: F-2024-001"
                  />
                </div>
                
                <div className="space-y-2">
                  <Label>Proveedor *</Label>
                  <Select value={proveedor} onValueChange={setProveedor}>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecciona un proveedor" />
                    </SelectTrigger>
                    <SelectContent>
                      {suppliers.map((supplier) => (
                        <SelectItem key={supplier.id} value={supplier.name}>
                          {supplier.name}
                        </SelectItem>
                      ))}
                      <SelectItem value="OTRO">Otro (escribir manualmente)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              
              {proveedor === 'OTRO' && (
                <div className="space-y-2">
                  <Label>Nombre del Proveedor *</Label>
                  <Input
                    value={proveedor}
                    onChange={(e) => setProveedor(e.target.value)}
                    placeholder="Nombre del proveedor"
                  />
                </div>
              )}
              
              <div className="space-y-2">
                <Label>CIF del Proveedor (opcional)</Label>
                <Input
                  value={proveedorCif}
                  onChange={(e) => setProveedorCif(e.target.value)}
                  placeholder="Ej: B12345678"
                />
              </div>
              
              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label>Base Imponible *</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={baseImponible}
                    onChange={(e) => setBaseImponible(e.target.value)}
                    placeholder="0.00"
                  />
                </div>
                
                <div className="space-y-2">
                  <Label>IVA % *</Label>
                  <Select value={ivaPorcentaje} onValueChange={setIvaPorcentaje}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="0">0%</SelectItem>
                      <SelectItem value="4">4%</SelectItem>
                      <SelectItem value="10">10%</SelectItem>
                      <SelectItem value="21">21%</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                
                <div className="space-y-2">
                  <Label>IVA Importe</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={ivaImporte}
                    readOnly
                    className="bg-gray-50"
                    placeholder="0.00"
                  />
                </div>
              </div>
            </>
          )}
          
          {/* Total */}
          <div className="space-y-2">
            <Label>Total del Gasto * (‚Ç¨)</Label>
            <Input
              type="number"
              step="0.01"
              value={total}
              onChange={(e) => setTotal(e.target.value)}
              placeholder="0.00"
              readOnly={tipoDocumento === 'FACTURA'}
              className={tipoDocumento === 'FACTURA' ? 'bg-gray-50' : ''}
            />
          </div>
          
          {/* M√©todo de Pago */}
          <div className="space-y-2">
            <Label>M√©todo de Pago *</Label>
            <Select value={metodoPago} onValueChange={setMetodoPago}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="EFECTIVO">Efectivo</SelectItem>
                <SelectItem value="TPV_SUMUP">TPV SumUp</SelectItem>
                <SelectItem value="TPV_UNICAJA">TPV Unicaja</SelectItem>
                <SelectItem value="TRANSFERENCIA">Transferencia Bancaria</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose} disabled={loading}>
              Cancelar
            </Button>
            <Button type="submit" disabled={loading} className="bg-green-600 hover:bg-green-700">
              {loading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Guardando...
                </>
              ) : (
                gastoToEdit ? 'Actualizar Gasto' : 'Crear Gasto'
              )}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
